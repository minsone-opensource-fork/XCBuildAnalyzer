<!DOCTYPE html>
<html>
<head>
<!--    <script src="https://d3js.org/d3.v5.min.js"></script>-->
<!--    <script src="https://unpkg.com/@hpcc-js/wasm@0.3.11/dist/index.min.js"></script>-->
<!--    <script src="https://unpkg.com/d3-graphviz@3.0.5/build/d3-graphviz.js"></script>-->
<!--    <script src="./d3.v5.min.js"></script>-->
<!--    <script src="./wasm_index.min.js"></script>-->
<!--    <script src="./d3-graphviz.js"></script>-->
<script src="./node_modules/d3/dist/d3.js"></script>
<script src="./node_modules/@hpcc-js/wasm/dist/graphviz.umd.js"  type="javascript/worker"></script>
<script src="./build/d3-graphviz.js"></script>
</head>
<body>


<div id="graph" style="text-align: center;background:#404040;cursor: default;"></div>
<script>

    'use strict';

    var margin = 20; // to avoid scrollbars

    var isDrawingEdge = false;
    var isDrawingNode = false;
    var startNode;
    var selectedEdge = d3.select(null);
    var selectedEdgeFill;
    var selectedEdgeStroke;
    var selectedNode = d3.select(null);
    var selectedNodeStroke;
    var selectedNodeFill;
    var isDown = false;

    var nodeIndex;
    var edgeIndex;
    var prevNodeName = 'b';

    var shapes = [
      "box",
      "polygon",
      "ellipse",
      "oval",

      "circle",
      "point",
      "egg",
      "triangle",

      "plaintext",
      "plain",
      "diamond",
      "trapezium",

      "parallelogram",
      "house",
      "pentagon",
      "hexagon",

      "septagon",
      "octagon",
      "doublecircle",
      "doubleoctagon",

      "tripleoctagon",
      "invtriangle",
      "invtrapezium",
      "invhouse",

      "Mdiamond",
      "Msquare",
      "Mcircle",
      "rect",

      "rectangle",
      "square",
      "star",
      "none",

      "underline",
      "cylinder",
      "note",
      "tab",

      "folder",
      "box3d",
      "component",
      "promoter",

      "cds",
      "terminator",
      "utr",
      "primersite",

      "restrictionsite",
      "fivepoverhang",
      "threepoverhang",
      "noverhang",

      "assembly",
      "signature",
      "insulator",
      "ribosite",

      "rnastab",
      "proteasesite",
      "proteinstab",
      "rpromoter",

      "rarrow",
      "larrow",
      "lpromoter",
    ];

    var dotSrc = ``;

    var graphviz = d3.select("#graph").graphviz()
        //.engine('circo')
        .attributer(attributer)
        .zoom(true)
        .addImage("img/edge.png", "40px", "40px")
        .addImage("img/edge_more_in_out.png", "40px", "40px")
        .addImage("img/edge_more_in.png", "40px", "40px")
        .addImage("img/edge_more_out.png", "40px", "40px")
        .transition(function() {
            return d3.transition().duration(300);
        });

    render();

    function attributer(datum, index, nodes) {
        var selection = d3.select(this);
        if (datum.tag == "svg") {
            var width = window.innerWidth - margin;
            var height = window.innerHeight - margin;
            //graphWidth = +selection.datum().attributes.width.replace('pt', '');
            //graphHeight = +selection.datum().attributes.height.replace('pt', '');
            //graphviz.zoomTranslateExtent([[rightPad + graphWidth - svgWidth, bottomPad - svgHeight], [svgWidth - leftPad, svgHeight - topPad - graphHeight]])
            var x = "10";
            var y = "10";
            var unit = 'px';
            selection
                .attr("width", width + unit)
                .attr("height", height + unit);
            datum.attributes.width = width + unit;
            datum.attributes.height = height + unit;
        }
    }

    function render() {
        graphviz
            .renderDot(dotSrc, startApp);
    }

    function startApp() {
        var nodes = d3.selectAll(".node");
        var edges = d3.selectAll(".edge");

        // click outside of nodes
        // d3.select(document).on("click mousedown", function(event) {
        //     //event.preventDefault();
        //     //event.stopPropagation();
        //     console.log('document click or mousedown');
        //     unSelectEdge();
        //     if (event.which == 2) {
        //         var graph0 = d3.select("#graph").selectWithoutDataPropagation("svg").selectWithoutDataPropagation("g");
        //         var width = 54;
        //         var height = 36;
        //         var [x0, y0] = d3.pointer(event, graph0.node());
        //         var x1 = x0 - width / 2;
        //         var x2 = x0 + width / 2;
        //         var y1 = y0 - height / 2;
        //         var y2 = y0 + height / 2;
        //         if (nodeIndex == null) {
        //             nodeIndex = d3.selectAll('.node').size();
        //         } else {
        //             nodeIndex += 1;
        //         }
        //         var shape = shapes[nodeIndex % shapes.length];
        //         var numLetters = 'z'.charCodeAt(0) - 'a'.charCodeAt(0) + 1;
        //         var letter = String.fromCharCode('a'.charCodeAt(0) + (nodeIndex % numLetters));
        //         var digit = Math.floor(nodeIndex / numLetters) || '';
        //         var nodeName = letter + digit;
        //         var fillcolor = d3.schemeCategory10[nodeIndex % 10];
        //         var color = 'black';
        //         graphviz
        //             .drawNode(x1, y1, nodeName, {shape: shape, text: nodeName, fillcolor: fillcolor, color: color})
        //             .insertDrawnNode(nodeName);
        //         var dotSrcLines = dotSrc.split('\n');
        //         var newNodeString = nodeName + ' [shape="' + shape + '" color="' + color + '"; fillcolor="' + fillcolor + '"; penwidth="1"]';
        //         dotSrcLines.splice(-1, 0, newNodeString);
        //         dotSrc = dotSrcLines.join('\n');
        //         render();
        //     }
        // });

        // keyup outside of nodes
        // d3.select(document).on("keyup", function(event) {
        //     //event.preventDefault();
        //     console.log('document keyup', event);
        //     if (event.keyCode == 27) {
        //         graphviz.removeDrawnEdge();
        //         unSelectEdge();
        //     }
        //     if (event.keyCode == 46) {
        //         deleteSelectedEdge();
        //         deleteSelectedNode();
        //         graphviz.removeDrawnEdge();
        //         render();
        //     }
        //     isDrawingEdge = false;
        // });

        // move
        // d3.select(document).on("mousemove", function(event) {
        //     //event.preventDefault();
        //     //event.stopPropagation();
        //     console.log('document mousemove');
        //     var graph0 = d3.select("#graph").selectWithoutDataPropagation("svg").selectWithoutDataPropagation("g");
        //     var [x0, y0] = d3.pointer(event, graph0.node());
        //     var shortening = 2; // avoid mouse pointing on edge
        //     if (isDrawingEdge) {
        //         graphviz
        //             .moveDrawnEdgeEndPoint(x0, y0,  {shortening: shortening})
        //     }
        // });

        // click and mousedown on nodes
        nodes.on("click", function(event) {
            event.preventDefault();
            console.log('node click or mousedown');
            var selectedImage = d3.select(this).select("image")._groups[0][0]
            var imageBounds = selectedImage.getBoundingClientRect()
            // the icon is always 1:1 (rectanle)
            var xRef = (event.clientX - imageBounds.x) / Math.min(imageBounds.width,imageBounds.height)
            var yRef = (event.clientY - imageBounds.y) / Math.min(imageBounds.width,imageBounds.height)
            var msg = "selected"
            var bufferSize = 0.3
            if (xRef >=0 && xRef< bufferSize && yRef < bufferSize && yRef >= 0) {
                msg ="expandIn"
            }
            if (xRef <=1 && xRef> 1 - bufferSize && yRef < bufferSize && yRef >= 0) {
                msg ="expandOut"
            }

            /*if (isDown) {
                isDown = false
                return;
            }
            isDown = true*/
            // Hacky
            var key = d3.select(this).selectChild('title').html()
            webkit.messageHandlers.bridge.postMessage('{"msg": "'+msg+'","id": \"' + key + '\"}')
            /*if (!isDrawingEdge){// && event.which == 1) {
                unSelectEdge();
                selectNode(d3.select(this));
            } else {
                console.log(event)
            }*/
        });

        // double-click on nodes


        // right-click on nodes
        // nodes.on("contextmenu", function(event) {
        //     //event.preventDefault();
        //     //event.stopPropagation();
        //     console.log('node contextmenu');
        //     unSelectEdge();
        //     unSelectNode();
        //     graphviz.removeDrawnEdge();
        //     startNode = d3.select(this);
        //     var graph0 = d3.select("#graph").selectWithoutDataPropagation("svg").selectWithoutDataPropagation("g");
        //     var [x0, y0] = d3.pointer(event, graph0.node());
        //         if (edgeIndex == null) {
        //             edgeIndex = d3.selectAll('.edge').size();
        //         } else {
        //             edgeIndex += 1;
        //         }
        //     var fillcolor = d3.schemePaired[(edgeIndex * 2) % 12];
        //     var color = d3.schemePaired[(edgeIndex * 2 + 1) % 12];

        //     graphviz
        //         .drawEdge(x0, y0, x0, y0, {fillcolor: fillcolor, color: color});
        //     isDrawingEdge = true;
        // });

        // click and mousedown on edges
        edges.on("click", function(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log('node click or mousedown');
            unSelectNode();
            selectEdge(d3.select(this));
        });

        // right-click outside of nodes
        d3.select(document).on("contextmenu", function(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log('document contextmenu');
            unSelectEdge();
        });

    }

    function selectEdge(edge) {
        unSelectEdge();
        selectedEdge = edge;
        selectedEdgeFill = selectedEdge.selectAll('polygon').attr("fill");
        selectedEdgeStroke = selectedEdge.selectAll('polygon').attr("stroke");
        selectedEdge.selectAll('path, polygon').attr("stroke", "red");
        selectedEdge.selectAll('polygon').attr("fill", "red");
    }

    function unSelectEdge() {
        selectedEdge.selectAll('path, polygon').attr("stroke", selectedEdgeStroke);
        selectedEdge.selectAll('polygon').attr("fill", selectedEdgeFill);
        selectedEdge = d3.select(null);
    }

    function deleteSelectedEdge() {
        selectedEdge.style("display", "none");
        if (selectedEdge.size() != 0) {
            var edgeName = selectedEdge.selectWithoutDataPropagation("title").text();
            edgeName = edgeName.replace('->', ' -> ');
            var dotSrcLines = dotSrc.split('\n');
            while (true) {
                var i = dotSrcLines.findIndex(function (element, index) {
                    return element.indexOf(edgeName) >= 0;
                });
                if (i < 0)
                    break;
                dotSrcLines.splice(i, 1);
            }
            dotSrc = dotSrcLines.join('\n');
        }
    }

    function selectNode(node) {
        unSelectNode();
        selectedNode = node;
        selectedNodeFill = selectedNode.selectAll('polygon, ellipse').attr("fill");
        selectedNodeStroke = selectedNode.selectAll('polygon, ellipse').attr("stroke");
        selectedNode.selectAll('polygon, ellipse').attr("stroke", "red");
        selectedNode.selectAll('polygon, ellipse').attr("fill", "red");
    }

    function unSelectNode() {
        selectedNode.selectAll('polygon, ellipse').attr("stroke", selectedNodeStroke);
        selectedNode.selectAll('polygon, ellipse').attr("fill", selectedNodeFill);
        selectedNode = d3.select(null);
    }

    function deleteSelectedNode() {
        selectedNode.style("display", "none");
        if (selectedNode.size() != 0) {
            var nodeName = selectedNode.selectWithoutDataPropagation("title").text();
            var dotSrcLines = dotSrc.split('\n');
            while (true) {
                var i = dotSrcLines.findIndex(function (element, index) {
                    var trimmedElement = element.trim();
                    if (trimmedElement == nodeName) {
                        return true;
                    }
                    if (trimmedElement.indexOf(nodeName + ' ') == 0) {
                        return true;
                    }
                    if (trimmedElement.indexOf(' ' + nodeName + ' ') >= 0) {
                        return true;
                    }
                    return false;
                });
                if (i < 0)
                    break;
                dotSrcLines.splice(i, 1);
            }
            dotSrc = dotSrcLines.join('\n');
        }
    }


  const log = (msg) => {
    const p = document.createElement('p')
    p.textContent = msg
    document.querySelector('#log').append(p)
  }
  // to receive messages from native

  const fromNative = (msg) => {
      console.log('from native: \"' + msg+"\"")
      //console.log(graphviz)

      var message = JSON.parse(msg)
      // Manual serialization
      /*var tokens = msg.split("|")
      var message = {
          "option": {
              "reset": JSON.parse(tokens[0])
          },
          "graph": tokens[1]
      }*/
      var g = graphviz
      if (message.option.reset) {
          try {
              // reset best effort- if the graph doesn't exists - do nothing
              g = g.resetZoom()
            } catch(err) {}
      }
          g.renderDot("strict digraph {edge [arrowhead=vee,color=\"#A8A8A8\",margin=0];\nnode [shape=plaintext,style=filled,fontcolor=\"#E4E5E5\",color=\"#00000000\",margin=0,padding=0];\nrankdir=\"LR\";bgcolor=\"#404040\"\n" + message.graph+"\n}", startApp)
      //webkit.messageHandlers.bridge.onMessage = this
    //log(graphviz)
    return ""
  }


    // terrible hack
    setInterval(() => {
        console.log('delayed')
        webkit.messageHandlers.bridge.onMessage = fromNative
    }, "100");
    //webkit.messageHandlers.bridge.onMessage = fromNative


    /*window.addEventListener("load", (event) => {
        log('loaded')
        log(webkit.messageHandlers.bridge)
        log(webkit.messageHandlers.bridge.onMessage)
        //webkit.messageHandlers.bridge.onMessage = fromNative
    });*/
</script>
</body>
</html>
